<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë¬¼ë•Œ â€” ë°”ë‹¤ ì¡°ì„ ì •ë³´</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --sea: #0a4f6e;
    --sea-light: #1a7fa0;
    --accent: #00c4a7;
    --danger: #ff6b6b;
    --blue: #5ba4f5;
    --text: #0d1f2d;
    --muted: #6b8fa3;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: #0d1f2d;
    color: #fff;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ë°°ê²½ */
  .bg-ocean {
    position: fixed; inset: 0; z-index: 0;
    background: linear-gradient(180deg, #0d1f2d 0%, #0a3347 50%, #0a4f6e 100%);
    overflow: hidden;
  }
  .bg-wave {
    position: absolute; bottom: 0; left: -50%; width: 200%; height: 180px;
    background: rgba(0, 196, 167, 0.04);
    border-radius: 50%;
    animation: bgWave 8s ease-in-out infinite;
  }
  .bg-wave:nth-child(2) { height: 130px; bottom: 20px; animation-duration: 11s; animation-delay: -3s; }
  .bg-wave:nth-child(3) { height: 100px; bottom: 40px; animation-duration: 14s; animation-delay: -6s; }
  @keyframes bgWave {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(-5%); }
  }

  .app {
    position: relative; z-index: 1;
    width: 100%; max-width: 480px; margin: 0 auto;
    height: 100dvh;
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* í—¤ë” */
  .header {
    padding: 48px 20px 10px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), #0097a7);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
  }
  .header-title { font-size: 1.1rem; font-weight: 900; letter-spacing: -0.5px; }
  .header-sub { font-size: 0.65rem; color: var(--muted); font-weight: 600; }
  .clock {
    font-family: 'DM Mono', monospace;
    font-size: 1.1rem; font-weight: 500; color: var(--accent);
    letter-spacing: 1px;
  }

  /* ìœ„ì¹˜ ì„ íƒ - ì»´íŒ©íŠ¸ */
  .location-bar {
    padding: 10px 20px;
    flex-shrink: 0;
  }
  .location-scroll {
    display: flex; gap: 7px; overflow-x: auto;
    scrollbar-width: none; -webkit-overflow-scrolling: touch;
  }
  .location-scroll::-webkit-scrollbar { display: none; }
  .station-chip {
    flex-shrink: 0;
    padding: 7px 14px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.55);
    font-size: 0.78rem; font-weight: 700; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
    font-family: 'Noto Sans KR', sans-serif;
    display: flex; align-items: center; gap: 5px;
  }
  .station-chip.active {
    background: rgba(0,196,167,0.2);
    border-color: var(--accent); color: var(--accent);
  }
  .station-chip:active { transform: scale(0.95); }
  .divider-chip {
    flex-shrink: 0;
    width: 1px; height: 28px; background: rgba(255,255,255,0.1);
    align-self: center; margin: 0 2px;
  }

  /* ë©”ì¸ ì»¨í…ì¸  ìŠ¤í¬ë¡¤ ì˜ì—­ */
  .content {
    flex: 1; overflow-y: auto;
    padding: 0 16px 20px;
    scrollbar-width: none;
  }
  .content::-webkit-scrollbar { display: none; }

  /* ë‚ ì”¨ ë°” */
  .weather-bar {
    display: none;
    align-items: center; gap: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px; padding: 10px 14px;
    margin-bottom: 10px;
  }
  .weather-bar.visible { display: flex; }
  .w-icon { font-size: 1.3rem; }
  .w-text { flex: 1; font-size: 0.78rem; font-weight: 700; }
  .w-sub { font-size: 0.65rem; color: var(--muted); }
  .w-wind {
    font-family: 'DM Mono', monospace;
    font-size: 0.9rem; font-weight: 500; color: var(--accent);
  }

  /* íŒŒë„ ì¹´ë“œ */
  .wave-card {
    border-radius: 24px; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 10px;
    position: relative;
    height: 160px;
    background: rgba(255,255,255,0.05);
  }
  .wave-fill {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(180deg, rgba(0,196,167,0.25), rgba(0,196,167,0.55));
    transition: height 2s cubic-bezier(0.4, 0, 0.2, 1);
    height: 0%;
  }
  .wave-fill::before {
    content: ""; position: absolute; top: -18px; left: -50%; width: 200%; height: 36px;
    background: rgba(0,196,167,0.35); border-radius: 50%;
    animation: waveTop 4s ease-in-out infinite;
  }
  @keyframes waveTop {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(-8%); }
  }
  .wave-info {
    position: absolute; inset: 0; z-index: 2;
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px;
  }
  .wave-left {}
  .tide-name-badge {
    display: inline-block;
    background: var(--accent); color: #0d1f2d;
    font-size: 0.65rem; font-weight: 900;
    padding: 2px 10px; border-radius: 20px;
    margin-bottom: 6px; letter-spacing: 0.5px;
  }
  .level-display {
    font-family: 'DM Mono', monospace;
    font-size: 3.2rem; font-weight: 500;
    line-height: 1; letter-spacing: -2px;
  }
  .level-unit { font-size: 1rem; opacity: 0.6; margin-left: 3px; }
  .tide-status {
    font-size: 0.72rem; font-weight: 700;
    color: var(--accent); margin-top: 4px;
    display: flex; align-items: center; gap: 3px;
  }
  .wave-right { text-align: right; }
  .time-left-label { font-size: 0.6rem; color: var(--muted); font-weight: 700; margin-bottom: 2px; }
  .time-left-val {
    font-family: 'DM Mono', monospace;
    font-size: 1rem; font-weight: 500; color: #fff;
  }
  .station-name-display {
    font-size: 0.65rem; color: var(--muted); font-weight: 700;
    margin-top: 8px; letter-spacing: 0.5px;
  }

  /* ë¬¼ë•Œ ë¦¬ìŠ¤íŠ¸ */
  .tide-list {}
  .tide-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 11px 14px; border-radius: 14px; margin-bottom: 7px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06);
  }
  .tide-item.current {
    background: rgba(0,196,167,0.1);
    border-color: rgba(0,196,167,0.3);
  }
  .tide-item.dim { opacity: 0.4; }
  .tide-item-left { display: flex; align-items: center; gap: 10px; }
  .tide-icon { font-size: 0.9rem; width: 18px; text-align: center; }
  .tide-level-text {
    font-size: 0.95rem; font-weight: 800;
    font-family: 'DM Mono', monospace; letter-spacing: -0.5px;
  }
  .tide-label { font-size: 0.6rem; color: var(--muted); margin-top: 1px; font-weight: 600; }
  .tide-time {
    font-family: 'DM Mono', monospace;
    font-size: 0.9rem; font-weight: 500; color: rgba(255,255,255,0.65);
  }
  .day-badge {
    font-size: 0.55rem; background: rgba(255,255,255,0.1);
    color: var(--muted); padding: 1px 5px; border-radius: 5px;
    font-weight: 700; margin-left: 5px; vertical-align: middle;
  }

  /* ë¡œë”© */
  .loading {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 120px; gap: 12px; color: var(--muted);
  }
  .loading-wave { display: flex; gap: 5px; }
  .loading-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent); opacity: 0.3;
    animation: loadPulse 1.2s ease-in-out infinite;
  }
  .loading-dot:nth-child(2) { animation-delay: 0.2s; }
  .loading-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes loadPulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.3); }
  }
  .loading-text { font-size: 0.72rem; font-weight: 700; letter-spacing: 1px; }

  .error-msg {
    text-align: center; padding: 30px;
    color: var(--danger); font-size: 0.82rem; font-weight: 700;
  }

  /* ìƒˆë¡œê³ ì¹¨ */
  .refresh-btn {
    position: fixed; bottom: 20px; right: 20px;
    width: 48px; height: 48px; border-radius: 50%;
    background: var(--accent); border: none;
    color: #0d1f2d; font-size: 1.2rem; cursor: pointer;
    box-shadow: 0 4px 18px rgba(0,196,167,0.4);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; z-index: 100;
  }
  .refresh-btn:active { transform: scale(0.92); }
  .refresh-btn.spinning svg { animation: spin 0.8s linear; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  .update-time {
    text-align: center; font-size: 0.6rem;
    color: rgba(255,255,255,0.2); padding: 6px;
    font-family: 'DM Mono', monospace;
  }

  /* ì´ˆê¸° ì•ˆë‚´ */
  .empty-state {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 100%; gap: 12px; color: var(--muted);
    padding: 40px;
  }
  .empty-icon { font-size: 2.5rem; opacity: 0.4; }
  .empty-text { font-size: 0.82rem; font-weight: 700; text-align: center; line-height: 1.6; }
</style>
</head>
<body>

<div class="bg-ocean">
  <div class="bg-wave"></div>
  <div class="bg-wave"></div>
  <div class="bg-wave"></div>
</div>

<div class="app">

  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-left">
      <div class="header-icon">ğŸŒŠ</div>
      <div>
        <div class="header-title">ë¬¼ë•Œ</div>
        <div class="header-sub">ì‹¤ì‹œê°„ ì¡°ì„ ì •ë³´</div>
      </div>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </div>

  <!-- ìœ„ì¹˜ ì„ íƒ ì¹© -->
  <div class="location-bar">
    <div class="location-scroll" id="location-scroll">
      <!-- ì œì£¼ -->
      <div class="station-chip" onclick="selectStation('ê¹€ë…•')">ğŸ„ ê¹€ë…•</div>
      <div class="station-chip" onclick="selectStation('ì œì£¼')">ğŸŒŠ ì œì£¼</div>
      <div class="station-chip" onclick="selectStation('ì„±ì‚°í¬')">ğŸŒ… ì„±ì‚°í¬</div>
      <div class="station-chip" onclick="selectStation('ì„œê·€í¬')">ğŸ¬ ì„œê·€í¬</div>
      <div class="station-chip" onclick="selectStation('ëª¨ìŠ¬í¬')">âš“ ëª¨ìŠ¬í¬</div>
      <div class="station-chip" onclick="selectStation('ì¶”ìë„')">ğŸ” ì¶”ìë„</div>
      <div class="divider-chip"></div>
      <!-- ì„œí•´ -->
      <div class="station-chip" onclick="selectStation('ë§ŒëŒ€í•­')">ğŸ¦€ ë§ŒëŒ€í•­</div>
      <div class="station-chip" onclick="selectStation('íƒœì•ˆ')">ğŸŒ¾ íƒœì•ˆ</div>
      <div class="station-chip" onclick="selectStation('ì•ˆí¥')">â›µ ì•ˆí¥</div>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¡¤ ì»¨í…ì¸  -->
  <div class="content" id="content">

    <!-- ë‚ ì”¨ -->
    <div class="weather-bar" id="weather-bar">
      <div class="w-icon" id="w-icon">ğŸŒ¤</div>
      <div>
        <div class="w-text" id="w-main">--</div>
        <div class="w-sub" id="w-detail">ë°”ë‹¤ ë‚ ì”¨</div>
      </div>
      <div class="w-wind" id="w-wind">--</div>
    </div>

    <!-- íŒŒë„ ì¹´ë“œ -->
    <div class="wave-card" id="wave-card" style="display:none;">
      <div class="wave-fill" id="wave-fill"></div>
      <div class="wave-info">
        <div class="wave-left">
          <div class="tide-name-badge" id="tide-name"></div>
          <div class="level-display">
            <span id="level-num">--</span><span class="level-unit">cm</span>
          </div>
          <div class="tide-status" id="tide-status"></div>
        </div>
        <div class="wave-right">
          <div class="time-left-label">ë‹¤ìŒ ë¬¼ë•Œê¹Œì§€</div>
          <div class="time-left-val" id="time-left">--</div>
          <div class="station-name-display" id="station-display"></div>
        </div>
      </div>
    </div>

    <!-- ë¬¼ë•Œ ë¦¬ìŠ¤íŠ¸ -->
    <div id="tide-list">
      <div class="empty-state">
        <div class="empty-icon">ğŸŒŠ</div>
        <div class="empty-text">ìœ„ì—ì„œ ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•˜ë©´<br>ì‹¤ì‹œê°„ ë¬¼ë•Œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”</div>
      </div>
    </div>

    <div class="update-time" id="update-time"></div>
  </div>

</div>

<button class="refresh-btn" id="refresh-btn" onclick="refresh()" title="ìƒˆë¡œê³ ì¹¨">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="23 4 23 10 17 10"></polyline>
    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
  </svg>
</button>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZnWjHzlOjJ285f5PxRtY85JehphoOFiEQp7r3pWHIr6SvXRwAeNJgTZPLBqNPNLHapA/exec';



// ê´€ì¸¡ì†Œ ì„¤ì •

const STATIONS = {

  'ê¹€ë…•':  { type: 'blend', obs1: 'DT_0004', obs2: 'DT_0022', w1: 0.48, w2: 0.52, timeCorr: +10, lat: 33.558, lng: 126.751 },

  'ì œì£¼':  { type: 'single', obs: 'DT_0004', lat: 33.5275, lng: 126.543 },

  'ì„±ì‚°í¬':{ type: 'single', obs: 'DT_0022', lat: 33.4747, lng: 126.927 },

  'ì„œê·€í¬':{ type: 'single', obs: 'DT_0061', lat: 33.2468, lng: 126.561 },

  'ëª¨ìŠ¬í¬':{ type: 'single', obs: 'DT_0020', lat: 33.2147, lng: 126.251 },

  'ì¶”ìë„':{ type: 'single', obs: 'DT_0021', lat: 33.9611, lng: 126.889 },

  'ë§ŒëŒ€í•­':{ type: 'scale',  obs: 'DT_0050', scale: 1.10, timeCorr: +3, lat: 36.626, lng: 126.309 },

  'íƒœì•ˆ':  { type: 'single', obs: 'DT_0050', lat: 36.7445, lng: 126.297 },

  'ì•ˆí¥':  { type: 'single', obs: 'DT_0067', lat: 36.6747, lng: 126.115 },

};



let currentStation = null;



// ì‹œê³„

function updateClock() {

  const now = new Date();

  const h = String(now.getHours()).padStart(2,'0');

  const m = String(now.getMinutes()).padStart(2,'0');

  const s = String(now.getSeconds()).padStart(2,'0');

  document.getElementById('clock').textContent = `${h}:${m}:${s}`;

}

setInterval(updateClock, 1000);

updateClock();



// ì¹© í™œì„±í™”

function setActiveChip(name) {

  document.querySelectorAll('.station-chip').forEach(c => {

    c.classList.toggle('active', c.textContent.trim().includes(name));

  });

}



// ê´€ì¸¡ì†Œ ì„ íƒ

async function selectStation(name) {

  currentStation = name;

  setActiveChip(name);

  const s = STATIONS[name];

  await Promise.all([loadTide(name), loadWeather(s.lat, s.lng)]);

}



// â”€â”€â”€ ë¬¼ë•Œ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadTide(name) {

  showLoading();

  document.getElementById('wave-card').style.display = 'none';



  try {

    // 1. ì´ì œ GAS ì£¼ì†Œê°€ ì•„ë‹ˆë¼ ë‚´ ì €ì¥ì†Œì˜ ë°ì´í„°ë¥¼ ì§ì ‘ ì½ìŠµë‹ˆë‹¤.

    const res = await fetch('./data/tide_all.json');

    if (!res.ok) throw new Error('ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

    

    const allData = await res.json();

    

    // 2. ì „ì²´ ë°ì´í„° ì¤‘ ì§€ê¸ˆ í´ë¦­í•œ ì§€ì (name) ê²ƒë§Œ ì™ ë¹¼ì˜µë‹ˆë‹¤.

    const data = allData[name];



    if (!data || data.length === 0) {

      showError(name + ' ë°ì´í„°ê°€ íŒŒì¼ì— ì—†ìŠµë‹ˆë‹¤.');

      return;

    }



    // 3. í™”ë©´ì— ì˜ˆì˜ê²Œ ê·¸ë¦¬ê¸°

    renderTide(data, name);

    document.getElementById('update-time').textContent =

      `ë™ê¸°í™”: ${new Date().toLocaleTimeString('ko-KR')}`;



  } catch(e) {

    showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);

    console.error("ì—ëŸ¬ ìƒì„¸:", e);

  }

}

async function fetchStation(obsCode) {

  const res = await fetch(GAS_URL, {

    method: 'POST',

    body: JSON.stringify({ station: getStationNameByObs(obsCode) || obsCode, obsCode })

  });

  return await res.json();

}



function getStationNameByObs(obs) {

  for (const [k, v] of Object.entries(STATIONS)) {

    if (v.obs === obs || v.obs1 === obs || v.obs2 === obs) return k;

  }

  return null;

}



// ì›ì‹œ ë°ì´í„°(GAS ë°°ì—´) â†’ íƒ€ì„ë¼ì¸ ì²˜ë¦¬

function rawToTides(data) {

  // GASì—ì„œ ì´ë¯¸ ì²˜ë¦¬ëœ ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ ë³€í™˜

  return Array.isArray(data) ? data : [];

}



// ë‹¨ì¼ ê´€ì¸¡ì†Œ ì²˜ë¦¬

function processTimeline(data, stationName) {

  return rawToTides(data);

}



// ê°€ì¤‘í‰ê·  (ê¹€ë…•)

function blendAndProcess(data1, data2, w1, w2, timeCorr, stationName) {

  // GASì—ì„œ ì´ë¯¸ ì²˜ë¦¬ëœ ë°ì´í„° â†’ current ì°¾ì•„ì„œ ìˆ˜ìœ„/ì‹œê°„ë§Œ ì¬ë³´ì •

  // ë‘ ë°ì´í„°ì…‹ì˜ ê° ë¬¼ë•Œë¥¼ ë§¤ì¹­í•´ì„œ í‰ê· 

  const tides1 = data1.filter(d => !d.isCurrent);

  const tides2 = data2.filter(d => !d.isCurrent);

  const current1 = data1.find(d => d.isCurrent);



  const used = new Set();

  const blended = [];



  tides1.forEach(t1 => {

    const matched = tides2

      .filter(t2 => t2.type === t1.type && !used.has(t2.time))

      .sort((a, b) => Math.abs(getMins(a) - getMins(t1)) - Math.abs(getMins(b) - getMins(t1)))[0];



    if (!matched) return;

    used.add(matched.time);



    const bMins = Math.round(getMins(t1) * w1 + getMins(matched) * w2) + timeCorr;

    const bLevel = Math.round(t1.level * w1 + matched.level * w2);

    const absMin = ((bMins % 1440) + 1440) % 1440;

    const h = String(Math.floor(absMin / 60)).padStart(2,'0');

    const m = String(absMin % 60).padStart(2,'0');



    blended.push({

      ...t1,

      time: `${h}:${m}`,

      mins: bMins,

      level: bLevel,

    });

  });



  blended.sort((a, b) => a.mins - b.mins);



  // í˜„ì¬ ë³´ê°„

  if (current1) {

    const nowMins = current1.mins;

    let nowLevel = current1.level;

    for (let i = 0; i < blended.length; i++) {

      if (nowMins < blended[i].mins) {

        if (i > 0) {

          const prev = blended[i-1], next = blended[i];

          const ratio = (nowMins - prev.mins) / (next.mins - prev.mins);

          nowLevel = Math.round(prev.level + (next.level - prev.level) * ratio);

        }

        break;

      }

    }

    const insertIdx = blended.findIndex(t => t.mins > nowMins);

    const cur = {

      ...current1,

      level: nowLevel,

      tideName: current1.tideName,

    };

    if (insertIdx === -1) blended.push(cur);

    else blended.splice(insertIdx, 0, cur);

  }



  return blended;

}



// ìˆ˜ìœ„ ë³´ì • (ë§ŒëŒ€í•­)

function scaleAndProcess(data, scale, timeCorr, stationName) {

  return data.map(item => {

    if (item.isCurrent) return item;

    const newMins = (item.mins || 0) + timeCorr;

    const absMin = ((newMins % 1440) + 1440) % 1440;

    const h = String(Math.floor(absMin / 60)).padStart(2,'0');

    const m = String(absMin % 60).padStart(2,'0');

    return {

      ...item,

      time: `${h}:${m}`,

      mins: newMins,

      level: item.isCurrent ? item.level : Math.round(item.level * scale),

    };

  });

}



function getMins(item) {

  if (item.mins != null) return item.mins;

  const [h, m] = item.time.split(':').map(Number);

  return (item.isNextDay ? h*60+m+1440 : h*60+m);

}



// â”€â”€â”€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTide(data, name) {

  const current = data.find(d => d.isCurrent);

  if (!current) { showError('í˜„ì¬ ë°ì´í„° ì—†ìŒ'); return; }



  // íŒŒë„ ì¹´ë“œ

  document.getElementById('wave-card').style.display = 'block';

  document.getElementById('station-display').textContent = `ğŸ“ ${name}`;



  const tideNameEl = document.getElementById('tide-name');

  tideNameEl.textContent = current.tideName || '';

  tideNameEl.style.display = current.tideName ? 'inline-block' : 'none';



  document.getElementById('level-num').textContent = current.level;



  const nowMins = getMins(current);

  const nextTide = data.find(d => !d.isCurrent && getMins(d) > nowMins);



  if (nextTide) {

    const isFalling = nextTide.type === 'low';

    const diff = getMins(nextTide) - nowMins;

    const h = Math.floor(diff / 60);

    const m = diff % 60;

    const label = isFalling ? 'ê°„ì¡°' : 'ë§Œì¡°';

    document.getElementById('tide-status').innerHTML =

      `<span>${isFalling ? 'â†“' : 'â†‘'}</span> ë¬¼ì´ ${isFalling ? 'ë¹ ì§€ëŠ” ì¤‘' : 'ì°¨ì˜¤ë¥´ëŠ” ì¤‘'}`;

    document.getElementById('time-left').textContent =

      `${label} ${h > 0 ? h+'ì‹œê°„ ' : ''}${m}ë¶„ ì „`;

  }



  // íŒŒë„ ë†’ì´

  const levels = data.map(d => d.level).filter(Boolean);

  const minL = Math.min(...levels), maxL = Math.max(...levels);

  const pct = maxL > minL ? ((current.level - minL) / (maxL - minL)) * 75 + 15 : 50;

  setTimeout(() => {

    document.getElementById('wave-fill').style.height = pct + '%';

  }, 100);



  // ë¦¬ìŠ¤íŠ¸

  let html = '';

  data.forEach(item => {

    const isCurrent  = item.isCurrent;

    const isYesterday = item.isYesterday;

    const isNextDay  = item.isNextDay;

    const isDim = isYesterday || isNextDay;

    const icon = isCurrent ? 'ğŸ“' : item.type === 'high' ? 'â–²' : 'â–¼';

    const iconColor = isCurrent ? '#00c4a7' : item.type === 'high' ? '#5ba4f5' : '#ff6b6b';

    const label = isCurrent ? 'í˜„ì¬ ì˜ˆìƒ ìˆ˜ìœ„' : item.type === 'high' ? 'ë§Œì¡°' : 'ê°„ì¡°';

    const badge = isYesterday ? '<span class="day-badge">ì–´ì œ</span>' :

                  isNextDay   ? '<span class="day-badge">ë‚´ì¼</span>' : '';



    html += `

      <div class="tide-item ${isCurrent ? 'current' : ''} ${isDim ? 'dim' : ''}">

        <div class="tide-item-left">

          <div class="tide-icon" style="color:${iconColor}">${icon}</div>

          <div>

            <div class="tide-level-text">${item.level}cm${badge}</div>

            <div class="tide-label">${label}</div>

          </div>

        </div>

        <div class="tide-time">${item.time}</div>

      </div>`;

  });

  document.getElementById('tide-list').innerHTML = html;

}



function showLoading() {

  document.getElementById('tide-list').innerHTML = `

    <div class="loading">

      <div class="loading-wave">

        <div class="loading-dot"></div>

        <div class="loading-dot"></div>

        <div class="loading-dot"></div>

      </div>

      <div class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘</div>

    </div>`;

  document.getElementById('level-num').textContent = '--';

  document.getElementById('tide-status').textContent = '';

  document.getElementById('time-left').textContent = '--';

  document.getElementById('wave-fill').style.height = '0%';

}



function showError(msg) {

  document.getElementById('tide-list').innerHTML = `<div class="error-msg">âš ï¸ ${msg}</div>`;

  document.getElementById('wave-card').style.display = 'none';

}



// â”€â”€â”€ ë‚ ì”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadWeather(lat, lng) {

  try {

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m,weather_code&wind_speed_unit=ms&timezone=Asia/Seoul`;

    const json = await (await fetch(url)).json();

    const c = json.current;

    const dirs = ["ë¶","ë¶ë™","ë™","ë‚¨ë™","ë‚¨","ë‚¨ì„œ","ì„œ","ë¶ì„œ"];

    const dir = dirs[Math.round(c.wind_direction_10m / 45) % 8];



    const emo = (code) => code===0?"â˜€ï¸":code<=2?"ğŸŒ¤":code===3?"â˜ï¸":code<=48?"ğŸŒ«":code<=55?"ğŸŒ¦":code<=65?"ğŸŒ§":code<=75?"â„ï¸":code<=82?"ğŸŒ§":"â›ˆ";

    const wname = (code) => code===0?"ë§‘ìŒ":code<=2?"ëŒ€ì²´ë¡œ ë§‘ìŒ":code===3?"íë¦¼":code<=48?"ì•ˆê°œ":code<=55?"ì´ìŠ¬ë¹„":code<=65?"ë¹„":code<=75?"ëˆˆ":code<=82?"ì†Œë‚˜ê¸°":"ë‡Œìš°";

    const wlv = (v) => v<1.5?"ì”ì”":v<3.3?"ì•½í•œë°”ëŒ":v<5.4?"ì‚°ë“¤ë°”ëŒ":v<7.9?"ê±´ë“¤ë°”ëŒ":v<10.7?"í”ë“¤ë°”ëŒ":"ê°•í’";



    document.getElementById('w-icon').textContent = emo(c.weather_code);

    document.getElementById('w-main').textContent = `${wname(c.weather_code)} Â· ${wlv(c.wind_speed_10m)}`;

    document.getElementById('w-detail').textContent = `${dir}í’`;

    document.getElementById('w-wind').textContent = `${c.wind_speed_10m.toFixed(1)}m/s`;

    document.getElementById('weather-bar').classList.add('visible');

  } catch(e) {}

}



// â”€â”€â”€ ìƒˆë¡œê³ ì¹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function refresh() {

  if (!currentStation) return;

  const btn = document.getElementById('refresh-btn');

  btn.classList.add('spinning');

  setTimeout(() => btn.classList.remove('spinning'), 800);

  const s = STATIONS[currentStation];

  await Promise.all([loadTide(currentStation), loadWeather(s.lat, s.lng)]);

}

  window.addEventListener('DOMContentLoaded', () => {

  updateClock();

  

  // ë¸Œë¼ìš°ì €ê°€ ê¸°ì–µí•˜ê³  ìˆëŠ” ë§ˆì§€ë§‰ ì¥ì†Œ í™•ì¸

  const lastSaved = localStorage.getItem('myTideStation');

  

  if (lastSaved && STATIONS[lastSaved]) {

    // ê¸°ì–µí•˜ëŠ” ê²Œ ìˆë‹¤ë©´ ë°”ë¡œ ì‹¤í–‰!

    selectStation(lastSaved);

  }

});



// ê´€ì¸¡ì†Œ ì„ íƒ í•¨ìˆ˜ (ì €ì¥ ê¸°ëŠ¥ ì¶”ê°€ ë²„ì „)

async function selectStation(name) {

  currentStation = name;

  setActiveChip(name);

  

  // ì„ íƒí•œ ì¥ì†Œë¥¼ ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì— ì €ì¥

  localStorage.setItem('myTideStation', name);

  

  const s = STATIONS[name];

  // ë‚ ì”¨ëŠ” ì‹¤ì‹œê°„ì´ ì¤‘ìš”í•˜ë‹ˆ ê·¸ëŒ€ë¡œ API í˜¸ì¶œí•˜ê³ , ë¬¼ë•ŒëŠ” íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.

  await Promise.all([loadTide(name), loadWeather(s.lat, s.lng)]);

}



// 10ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ 

setInterval(() => { if (currentStation) refresh(); }, 600000);
</script>
</body>
</html>
