<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë¬¼ë•Œ â€” ë°”ë‹¤ ì¡°ì„ ì •ë³´</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --accent: #00c4a7;
    --danger: #ff6b6b;
    --blue: #5ba4f5;
    --muted: #6b8fa3;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: #0d1f2d;
    color: #fff;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .bg-ocean {
    position: fixed; inset: 0; z-index: 0;
    background: linear-gradient(180deg, #0d1f2d 0%, #0a3347 50%, #0a4f6e 100%);
    overflow: hidden;
  }
  .bg-wave {
    position: absolute; bottom: 0; left: -50%; width: 200%; height: 180px;
    background: rgba(0,196,167,0.04); border-radius: 50%;
    animation: bgWave 8s ease-in-out infinite;
  }
  .bg-wave:nth-child(2) { height: 130px; bottom: 20px; animation-duration: 11s; animation-delay: -3s; }
  .bg-wave:nth-child(3) { height: 100px; bottom: 40px; animation-duration: 14s; animation-delay: -6s; }
  @keyframes bgWave { 0%,100%{transform:translateX(0)} 50%{transform:translateX(-5%)} }

  .app {
    position: relative; z-index: 1;
    width: 100%; max-width: 480px; margin: 0 auto;
    height: 100dvh;
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  /* í—¤ë” */
  .header {
    padding: 48px 20px 8px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), #0097a7);
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
  }
  .header-title { font-size: 1.1rem; font-weight: 900; letter-spacing: -0.5px; }
  .header-sub { font-size: 0.65rem; color: var(--muted); font-weight: 600; }
  .clock { font-family:'DM Mono',monospace; font-size:1.1rem; font-weight:500; color:var(--accent); letter-spacing:1px; }

  /* ì§€ì—­ íƒ­ */
  .region-bar {
    padding: 6px 20px 0;
    display: flex; gap: 6px;
    flex-shrink: 0;
  }
  .region-tab {
    padding: 5px 14px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.45);
    font-size: 0.72rem; font-weight: 900; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
    font-family: 'Noto Sans KR', sans-serif;
    letter-spacing: 0.3px;
  }
  .region-tab.active {
    background: var(--accent); border-color: var(--accent); color: #0d1f2d;
  }
  .region-tab:active { transform: scale(0.95); }

  /* ê´€ì¸¡ì†Œ ì¹© */
  .location-bar { padding: 8px 20px; flex-shrink: 0; }
  .location-scroll {
    display: flex; gap: 6px; overflow-x: auto;
    scrollbar-width: none; -webkit-overflow-scrolling: touch;
  }
  .location-scroll::-webkit-scrollbar { display: none; }
  .station-chip {
    flex-shrink: 0;
    padding: 6px 13px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.5);
    font-size: 0.75rem; font-weight: 700; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
    font-family: 'Noto Sans KR', sans-serif;
  }
  .station-chip.active {
    background: rgba(0,196,167,0.2);
    border-color: var(--accent); color: var(--accent);
  }
  .station-chip:active { transform: scale(0.95); }

  /* ì»¨í…ì¸  */
  .content { flex: 1; overflow-y: auto; padding: 0 16px 20px; scrollbar-width: none; }
  .content::-webkit-scrollbar { display: none; }

  /* ë‚ ì”¨ */
  .weather-bar {
    display: none; align-items: center; gap: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px; padding: 10px 14px; margin-bottom: 10px;
  }
  .weather-bar.visible { display: flex; }
  .w-icon { font-size: 1.3rem; }
  .w-text { flex: 1; font-size: 0.78rem; font-weight: 700; }
  .w-sub { font-size: 0.65rem; color: var(--muted); }
  .w-wind { font-family:'DM Mono',monospace; font-size:0.9rem; font-weight:500; color:var(--accent); }

  /* íŒŒë„ ì¹´ë“œ */
  .wave-card {
    border-radius: 24px; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 10px; position: relative; height: 160px;
    background: rgba(255,255,255,0.05);
  }

  /* ë¬¼ ì±„ìš°ê¸° â€” ì°¨ì˜¤ë¥¼ ë•Œ */
  .wave-fill {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(180deg, rgba(0,196,167,0.25), rgba(0,196,167,0.6));
    height: 0%;
    transition: height 2.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ë¹ ì§ˆ ë•Œ: top ê¸°ì¤€ìœ¼ë¡œ ì „í™˜ */

  .wave-fill::before {
    content: ""; position: absolute; top: -18px; left: -50%; width: 200%; height: 36px;
    background: rgba(0,196,167,0.35); border-radius: 50%;
    animation: waveTop 4s ease-in-out infinite;
  }

  @keyframes waveTop { 0%,100%{transform:translateX(0)} 50%{transform:translateX(-8%)} }

  .wave-info {
    position: absolute; inset: 0; z-index: 2;
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px;
  }
  .tide-name-badge {
    display: inline-block; background: var(--accent); color: #0d1f2d;
    font-size: 0.65rem; font-weight: 900;
    padding: 2px 10px; border-radius: 20px; margin-bottom: 6px; letter-spacing: 0.5px;
  }
  .level-display { font-family:'DM Mono',monospace; font-size:3.2rem; font-weight:500; line-height:1; letter-spacing:-2px; }
  .level-unit { font-size:1rem; opacity:0.6; margin-left:3px; }
  .tide-status { font-size:0.72rem; font-weight:700; color:var(--accent); margin-top:4px; display:flex; align-items:center; gap:3px; }
  .wave-right { text-align: right; }
  .time-left-label { font-size:0.6rem; color:var(--muted); font-weight:700; margin-bottom:2px; }
  .time-left-val { font-family:'DM Mono',monospace; font-size:1rem; font-weight:500; color:#fff; }
  .station-name-display { font-size:0.65rem; color:var(--muted); font-weight:700; margin-top:8px; letter-spacing:0.5px; }

  /* ë¬¼ë•Œ ë¦¬ìŠ¤íŠ¸ */
  .tide-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 11px 14px; border-radius: 14px; margin-bottom: 7px;
    background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06);
  }
  .tide-item.current { background:rgba(0,196,167,0.1); border-color:rgba(0,196,167,0.3); }
  .tide-item.dim { opacity: 0.4; }
  .tide-item-left { display:flex; align-items:center; gap:10px; }
  .tide-icon { font-size:0.9rem; width:18px; text-align:center; }
  .tide-level-text { font-size:0.95rem; font-weight:800; font-family:'DM Mono',monospace; letter-spacing:-0.5px; }
  .tide-label { font-size:0.6rem; color:var(--muted); margin-top:1px; font-weight:600; }
  .tide-time { font-family:'DM Mono',monospace; font-size:0.9rem; font-weight:500; color:rgba(255,255,255,0.65); }
  .day-badge { font-size:0.55rem; background:rgba(255,255,255,0.1); color:var(--muted); padding:1px 5px; border-radius:5px; font-weight:700; margin-left:5px; vertical-align:middle; }

  /* ë¡œë”© */
  .loading { display:flex; flex-direction:column; align-items:center; justify-content:center; height:120px; gap:12px; color:var(--muted); }
  .loading-wave { display:flex; gap:5px; }
  .loading-dot { width:7px; height:7px; border-radius:50%; background:var(--accent); opacity:0.3; animation:loadPulse 1.2s ease-in-out infinite; }
  .loading-dot:nth-child(2) { animation-delay:0.2s; }
  .loading-dot:nth-child(3) { animation-delay:0.4s; }
  @keyframes loadPulse { 0%,100%{opacity:0.3;transform:scale(1)} 50%{opacity:1;transform:scale(1.3)} }
  .loading-text { font-size:0.72rem; font-weight:700; letter-spacing:1px; }

  .error-msg { text-align:center; padding:30px; color:var(--danger); font-size:0.82rem; font-weight:700; }

  /* ìƒˆë¡œê³ ì¹¨ */
  .refresh-btn {
    position:fixed; bottom:20px; right:20px;
    width:48px; height:48px; border-radius:50%;
    background:var(--accent); border:none; color:#0d1f2d; cursor:pointer;
    box-shadow:0 4px 18px rgba(0,196,167,0.4);
    display:flex; align-items:center; justify-content:center;
    transition:all 0.2s; z-index:100;
  }
  .refresh-btn:active { transform:scale(0.92); }
  .refresh-btn.spinning svg { animation:spin 0.8s linear; }
  @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

  .update-time { text-align:center; font-size:0.6rem; color:rgba(255,255,255,0.2); padding:6px; font-family:'DM Mono',monospace; }

  .empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:200px; gap:12px; color:var(--muted); padding:40px; }
  .empty-icon { font-size:2.5rem; opacity:0.4; }
  .empty-text { font-size:0.82rem; font-weight:700; text-align:center; line-height:1.6; }
</style>
</head>
<body>

<div class="bg-ocean">
  <div class="bg-wave"></div><div class="bg-wave"></div><div class="bg-wave"></div>
</div>

<div class="app">

  <div class="header">
    <div class="header-left">
      <div class="header-icon">ğŸŒŠ</div>
      <div>
        <div class="header-title">ë¬¼ë•Œ</div>
        <div class="header-sub">ì‹¤ì‹œê°„ ì¡°ì„ ì •ë³´</div>
      </div>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </div>

  <!-- ì§€ì—­ íƒ­ -->
  <div class="region-bar">
    <button class="region-tab active" onclick="switchRegion('jeju')">ğŸ ì œì£¼</button>
    <button class="region-tab" onclick="switchRegion('west')">ğŸŒŠ ì„œí•´</button>
    <button class="region-tab" onclick="switchRegion('south')">ğŸ¬ ë‚¨í•´</button>
    <button class="region-tab" onclick="switchRegion('east')">ğŸ” ë™í•´</button>
  </div>

  <!-- ê´€ì¸¡ì†Œ ì¹© -->
  <div class="location-bar">
    <div class="location-scroll" id="location-scroll"></div>
  </div>

  <div class="content">

    <div class="weather-bar" id="weather-bar">
      <div class="w-icon" id="w-icon">ğŸŒ¤</div>
      <div>
        <div class="w-text" id="w-main">--</div>
        <div class="w-sub" id="w-detail">ë°”ë‹¤ ë‚ ì”¨</div>
      </div>
      <div class="w-wind" id="w-wind">--</div>
    </div>

    <div class="wave-card" id="wave-card" style="display:none;">
      <div class="wave-fill" id="wave-fill"></div>
      <div class="wave-info">
        <div>
          <div class="tide-name-badge" id="tide-name"></div>
          <div class="level-display"><span id="level-num">--</span><span class="level-unit">cm</span></div>
          <div class="tide-status" id="tide-status"></div>
        </div>
        <div class="wave-right">
          <div class="time-left-label">ë‹¤ìŒ ë¬¼ë•Œê¹Œì§€</div>
          <div class="time-left-val" id="time-left">--</div>
          <div class="station-name-display" id="station-display"></div>
        </div>
      </div>
    </div>

    <div id="tide-list">
      <div class="empty-state">
        <div class="empty-icon">ğŸŒŠ</div>
        <div class="empty-text">ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•˜ë©´<br>ì‹¤ì‹œê°„ ë¬¼ë•Œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”</div>
      </div>
    </div>

    <div class="update-time" id="update-time"></div>
  </div>
</div>

<button class="refresh-btn" id="refresh-btn" onclick="refresh()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="23 4 23 10 17 10"></polyline>
    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
  </svg>
</button>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycby3S8MfzcX6pEUDpaOsC1ucQrP6go65KPedXvgNibHTUKpeJVkwSTpE8EudlBxZpn2lBA/exec';

// â”€â”€â”€ ê´€ì¸¡ì†Œ ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATIONS = {
  // ì œì£¼
  'ê¹€ë…•':    { type:'blend',  obs1:'DT_0004', obs2:'DT_0022', w1:0.48, w2:0.52, timeCorr:+10, lat:33.558,  lng:126.751, region:'jeju' },
  'ì œì£¼':    { type:'single', obs:'DT_0004',  lat:33.5275, lng:126.543,  region:'jeju' },
  'ì„±ì‚°í¬':  { type:'single', obs:'DT_0022',  lat:33.4747, lng:126.927,  region:'jeju' },
  'ì„œê·€í¬':  { type:'single', obs:'DT_0061',  lat:33.2468, lng:126.561,  region:'jeju' },
  'ëª¨ìŠ¬í¬':  { type:'single', obs:'DT_0020',  lat:33.2147, lng:126.251,  region:'jeju' },
  'ì¶”ìë„':  { type:'single', obs:'DT_0021',  lat:33.9611, lng:126.889,  region:'jeju' },
  // ì„œí•´
  'ë§ŒëŒ€í•­':  { type:'scale',  obs:'DT_0050',  scale:1.10, timeCorr:+3, lat:36.626,  lng:126.309, region:'west' },
  'íƒœì•ˆ':    { type:'single', obs:'DT_0050',  lat:36.7445, lng:126.297,  region:'west' },
  'ì•ˆí¥':    { type:'single', obs:'DT_0067',  lat:36.6747, lng:126.115,  region:'west' },
  'ë³´ë ¹':    { type:'single', obs:'DT_0025',  lat:36.4167, lng:126.483,  region:'west' },
  'ì„œì²œë§ˆëŸ‰':{ type:'single', obs:'DT_0051',  lat:36.0833, lng:126.633,  region:'west' },
  'êµ°ì‚°':    { type:'single', obs:'DT_0018',  lat:35.9833, lng:126.717,  region:'west' },
  'ìœ„ë„':    { type:'single', obs:'DT_0068',  lat:35.6167, lng:126.300,  region:'west' },
  'ì–´ì²­ë„':  { type:'single', obs:'DT_0037',  lat:36.1167, lng:125.983,  region:'west' },
  'í‘ì‚°ë„':  { type:'single', obs:'DT_0035',  lat:34.6833, lng:125.433,  region:'west' },
  'í–¥í™”ë„':  { type:'single', obs:'DT_0066',  lat:35.8833, lng:126.517,  region:'west' },
  'ì¸ì²œì†¡ë„':{ type:'single', obs:'DT_0052',  lat:37.3833, lng:126.633,  region:'west' },
  'ê°•í™”ëŒ€êµ':{ type:'single', obs:'DT_0032',  lat:37.7333, lng:126.533,  region:'west' },
  'ë•ì ë„':  { type:'single', obs:'DT_0065',  lat:37.2333, lng:126.133,  region:'west' },
  'êµ´ì—…ë„':  { type:'single', obs:'DT_0038',  lat:37.1833, lng:126.250,  region:'west' },
  'ëŒ€ì²­ë„':  { type:'single', obs:'DT_0036',  lat:37.8333, lng:124.717,  region:'west' },
  'ì—°í‰ë„':  { type:'single', obs:'DT_0060',  lat:37.6667, lng:125.683,  region:'west' },
  'ì¥í•­':    { type:'single', obs:'DT_0024',  lat:36.0000, lng:126.700,  region:'west' },
  // ë‚¨í•´
  'í†µì˜':    { type:'single', obs:'DT_0014',  lat:34.8500, lng:128.433,  region:'south' },
  'ê±°ë¬¸ë„':  { type:'single', obs:'DT_0031',  lat:34.0167, lng:127.300,  region:'south' },
  'ë§ˆì‚°':    { type:'single', obs:'DT_0062',  lat:35.2000, lng:128.567,  region:'south' },
  'ê°€ë•ë„':  { type:'single', obs:'DT_0063',  lat:35.0167, lng:128.817,  region:'south' },
  'ì§„í•´':    { type:'single', obs:'DT_0054',  lat:35.1000, lng:128.700,  region:'south' },
  // ë™í•´
  'ì†ì´ˆ':    { type:'single', obs:'DT_0012',  lat:38.2000, lng:128.600,  region:'east' },
  'í›„í¬':    { type:'single', obs:'DT_0011',  lat:36.6833, lng:129.450,  region:'east' },
  'ìš¸ë¦‰ë„':  { type:'single', obs:'DT_0013',  lat:37.5000, lng:130.900,  region:'east' },
};

const REGION_EMOJI = {
  jeju:  { ê¹€ë…•:'ğŸ„', ì œì£¼:'ğŸŒŠ', ì„±ì‚°í¬:'ğŸŒ…', ì„œê·€í¬:'ğŸ¬', ëª¨ìŠ¬í¬:'âš“', ì¶”ìë„:'ğŸ”' },
  west:  { ë§ŒëŒ€í•­:'ğŸ¦€', íƒœì•ˆ:'ğŸŒ¾', ì•ˆí¥:'â›µ', ë³´ë ¹:'ğŸ–', ì„œì²œë§ˆëŸ‰:'ğŸ£', êµ°ì‚°:'ğŸŒ‰', ìœ„ë„:'ğŸ', ì–´ì²­ë„:'âš“', í‘ì‚°ë„:'ğŸŒ‘', í–¥í™”ë„:'ğŸŒ¿', ì¸ì²œì†¡ë„:'ğŸ™', ê°•í™”ëŒ€êµ:'ğŸŒ', ë•ì ë„:'ğŸ”', êµ´ì—…ë„:'ğŸ¦…', ëŒ€ì²­ë„:'ğŸ”µ', ì—°í‰ë„:'ğŸŸ¡', ì¥í•­:'ğŸŒŠ' },
  south: { í†µì˜:'ğŸ¦ª', ê±°ë¬¸ë„:'ğŸ', ë§ˆì‚°:'ğŸŸ', ê°€ë•ë„:'âš“', ì§„í•´:'ğŸŒ¸' },
  east:  { ì†ì´ˆ:'ğŸŒŠ', í›„í¬:'ğŸ£', ìš¸ë¦‰ë„:'ğŸŒ‹' },
};

let currentStation = null;
let currentRegion  = 'jeju';

// â”€â”€â”€ ì‹œê³„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const n = new Date();
  document.getElementById('clock').textContent =
    String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')+':'+String(n.getSeconds()).padStart(2,'0');
}
setInterval(updateClock, 1000); updateClock();

// â”€â”€â”€ ì§€ì—­ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchRegion(region) {
  currentRegion = region;
  document.querySelectorAll('.region-tab').forEach((t, i) => {
    const regions = ['jeju','west','south','east'];
    t.classList.toggle('active', regions[i] === region);
  });
  renderChips();
}

function renderChips() {
  const scroll = document.getElementById('location-scroll');
  const emojis = REGION_EMOJI[currentRegion] || {};
  const names  = Object.keys(STATIONS).filter(k => STATIONS[k].region === currentRegion);
  scroll.innerHTML = names.map(name => `
    <div class="station-chip ${currentStation===name?'active':''}" onclick="selectStation('${name}')">
      ${emojis[name]||'ğŸ“'} ${name}
    </div>`).join('');
}

// â”€â”€â”€ ì¹© í™œì„±í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setActiveChip(name) {
  document.querySelectorAll('.station-chip').forEach(c => {
    c.classList.toggle('active', c.textContent.trim().includes(name));
  });
}

// â”€â”€â”€ ê´€ì¸¡ì†Œ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function selectStation(name) {
  currentStation = name;
  localStorage.setItem('lastStation', name);
  localStorage.setItem('lastRegion', STATIONS[name].region);
  setActiveChip(name);
  const s = STATIONS[name];
  await Promise.all([loadTide(name), loadWeather(s.lat, s.lng)]);
}

// â”€â”€â”€ ë¬¼ë•Œ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTide(name) {
  showLoading();
  document.getElementById('wave-card').style.display = 'none';
  try {
    const s = STATIONS[name];
    let data;
    if (s.type === 'blend') {
      const [r1, r2] = await Promise.all([callGAS(s.obs1), callGAS(s.obs2)]);
      data = blendTides(r1, r2, s.w1, s.w2, s.timeCorr);
    } else if (s.type === 'scale') {
      const raw = await callGAS(s.obs);
      data = scaleTides(raw, s.scale, s.timeCorr);
    } else {
      data = await callGAS(s.obs);
    }
    data = data.filter(d => d && (d.isCurrent || d.time));
    if (!data || !data.length || data[0]?.error) { showError(data?.[0]?.error || "ë°ì´í„° ì—†ìŒ"); return; }
    renderTide(data, name);
    document.getElementById('update-time').textContent = `ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
  } catch(e) { showError('ì˜¤ë¥˜: ' + e.message); }
}

async function callGAS(obsCode) {
  try {
    const res = await fetch(GAS_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ obsCode }) });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜");
    return data;
  } catch(e) {
    console.error("GAS ì˜¤ë¥˜:", obsCode, e);
    return [{ error: e.message }];
  }
}

// â”€â”€â”€ ê°€ì¤‘í‰ê·  (ê¹€ë…•) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function blendTides(data1, data2, w1, w2, timeCorr) {
  const tides1  = data1.filter(d => !d.isCurrent);
  const tides2  = data2.filter(d => !d.isCurrent);
  const current = data1.find(d => d.isCurrent);
  const used = new Set();
  const blended = [];
  tides1.forEach(t1 => {
    const matched = tides2
      .filter(t2 => t2.type===t1.type && !used.has(t2.time))
      .sort((a,b) => Math.abs(toMins(a)-toMins(t1)) - Math.abs(toMins(b)-toMins(t1)))[0];
    if (!matched) return;
    used.add(matched.time);
    const bMins  = Math.round(toMins(t1)*w1 + toMins(matched)*w2) + timeCorr;
    const bLevel = Math.round(t1.level*w1 + matched.level*w2);
    blended.push({ ...t1, time:minsToTime(bMins), mins:bMins, level:bLevel });
  });
  blended.sort((a,b) => a.mins - b.mins);
  if (current) {
    const nowMins = toMins(current);
    let nowLevel  = current.level;
    for (let i=0; i<blended.length; i++) {
      if (nowMins < blended[i].mins) {
        if (i>0) {
          const p=blended[i-1], n=blended[i];
          nowLevel = Math.round(p.level + (n.level-p.level)*(nowMins-p.mins)/(n.mins-p.mins));
        }
        break;
      }
    }
    const idx = blended.findIndex(t => t.mins > nowMins);
    const cur = { ...current, level:nowLevel };
    if (idx===-1) blended.push(cur); else blended.splice(idx,0,cur);
  }
  return blended;
}

// â”€â”€â”€ ìˆ˜ìœ„ ë³´ì • (ë§ŒëŒ€í•­) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scaleTides(data, scale, timeCorr) {
  return data.map(item => {
    if (item.isCurrent) return item;
    const newMins = toMins(item) + timeCorr;
    return { ...item, time:minsToTime(newMins), mins:newMins, level:Math.round(item.level*scale) };
  });
}

// â”€â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toMins(item) {
  if (!item) return 0;
  if (item.mins != null) return item.mins;
  if (!item.time) return 0;
  const [h,m] = item.time.split(':').map(Number);
  return item.isNextDay ? h*60+m+1440 : h*60+m;
}
function minsToTime(mins) {
  const abs = ((mins%1440)+1440)%1440;
  return String(Math.floor(abs/60)).padStart(2,'0')+':'+String(abs%60).padStart(2,'0');
}

// â”€â”€â”€ íŒŒë„ ì• ë‹ˆë©”ì´ì…˜ (ë°©í–¥ êµ¬ë¶„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateWave(pct, isFalling) {
  const el = document.getElementById('wave-fill');
  // í•­ìƒ bottom ê¸°ì¤€, falling í´ë˜ìŠ¤ ì œê±°
  el.classList.remove('falling');
  el.style.top = '';

  if (!isFalling) {
    // ì°¨ì˜¤ë¥¼ ë•Œ: 0%ì—ì„œ pct%ë¡œ ì˜¬ë¼ì˜´
    el.style.transition = 'none';
    el.style.height = '0%';
    void el.offsetWidth;
    el.style.transition = 'height 2.2s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => { el.style.height = pct + '%'; }, 80);
  } else {
    // ë¹ ì§ˆ ë•Œ: 100%ì—ì„œ pct%ë¡œ ì¤„ì–´ë“¦
    el.style.transition = 'none';
    el.style.height = '100%';
    void el.offsetWidth;
    el.style.transition = 'height 2.2s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => { el.style.height = pct + '%'; }, 80);
  }
}

// â”€â”€â”€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTide(data, name) {
  const current = data.find(d => d.isCurrent);
  if (!current) { showError('í˜„ì¬ ë°ì´í„° ì—†ìŒ'); return; }

  document.getElementById('wave-card').style.display = 'block';
  document.getElementById('station-display').textContent = `ğŸ“ ${name}`;

  const tideNameEl = document.getElementById('tide-name');
  tideNameEl.textContent = current.tideName || '';
  tideNameEl.style.display = current.tideName ? 'inline-block' : 'none';
  document.getElementById('level-num').textContent = current.level;

  const nowMins  = toMins(current);
  const nextTide = data.find(d => !d.isCurrent && toMins(d) > nowMins);
  const isFalling = nextTide?.type === 'low';

  if (nextTide) {
    const diff = toMins(nextTide) - nowMins;
    const h = Math.floor(diff/60), m = diff%60;
    document.getElementById('tide-status').innerHTML =
      `<span>${isFalling?'â†“':'â†‘'}</span> ë¬¼ì´ ${isFalling?'ë¹ ì§€ëŠ” ì¤‘':'ì°¨ì˜¤ë¥´ëŠ” ì¤‘'}`;
    document.getElementById('time-left').textContent =
      `${isFalling?'ê°„ì¡°':'ë§Œì¡°'} ${h>0?h+'ì‹œê°„ ':''}${m}ë¶„ ì „`;
  }

  // íŒŒë„ ë†’ì´ ê³„ì‚° & ë°©í–¥ ì• ë‹ˆë©”ì´ì…˜
  const levels = data.map(d => d.level).filter(Boolean);
  const minL = Math.min(...levels), maxL = Math.max(...levels);
  const pct = maxL > minL ? ((current.level - minL) / (maxL - minL)) * 75 + 15 : 50;
  animateWave(pct, isFalling);

  // ë¦¬ìŠ¤íŠ¸
  document.getElementById('tide-list').innerHTML = data.map(item => {
    const isCur  = item.isCurrent;
    const isDim  = item.isYesterday || item.isNextDay;
    const icon   = isCur ? 'ğŸ“' : item.type==='high' ? 'â–²' : 'â–¼';
    const color  = isCur ? '#00c4a7' : item.type==='high' ? '#5ba4f5' : '#ff6b6b';
    const label  = isCur ? 'í˜„ì¬ ì˜ˆìƒ ìˆ˜ìœ„' : item.type==='high' ? 'ë§Œì¡°' : 'ê°„ì¡°';
    const badge  = item.isYesterday ? '<span class="day-badge">ì–´ì œ</span>' :
                   item.isNextDay   ? '<span class="day-badge">ë‚´ì¼</span>' : '';
    return `
      <div class="tide-item ${isCur?'current':''} ${isDim?'dim':''}">
        <div class="tide-item-left">
          <div class="tide-icon" style="color:${color}">${icon}</div>
          <div>
            <div class="tide-level-text">${item.level}cm${badge}</div>
            <div class="tide-label">${label}</div>
          </div>
        </div>
        <div class="tide-time">${item.time}</div>
      </div>`;
  }).join('');
}

function showLoading() {
  document.getElementById('tide-list').innerHTML = `
    <div class="loading">
      <div class="loading-wave"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>
      <div class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘</div>
    </div>`;
  document.getElementById('level-num').textContent = '--';
  document.getElementById('tide-status').textContent = '';
  document.getElementById('time-left').textContent = '--';
  document.getElementById('wave-fill').style.height = '0%';
}
function showError(msg) {
  document.getElementById('tide-list').innerHTML = `<div class="error-msg">âš ï¸ ${msg}</div>`;
  document.getElementById('wave-card').style.display = 'none';
}

// â”€â”€â”€ ë‚ ì”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadWeather(lat, lng) {
  try {
    const c = (await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m,weather_code&wind_speed_unit=ms&timezone=Asia/Seoul`)).json()).current;
    const dirs  = ["ë¶","ë¶ë™","ë™","ë‚¨ë™","ë‚¨","ë‚¨ì„œ","ì„œ","ë¶ì„œ"];
    const dir   = dirs[Math.round(c.wind_direction_10m/45)%8];
    const emo   = v => v===0?"â˜€ï¸":v<=2?"ğŸŒ¤":v===3?"â˜ï¸":v<=48?"ğŸŒ«":v<=55?"ğŸŒ¦":v<=65?"ğŸŒ§":v<=75?"â„ï¸":v<=82?"ğŸŒ§":"â›ˆ";
    const wname = v => v===0?"ë§‘ìŒ":v<=2?"ëŒ€ì²´ë¡œ ë§‘ìŒ":v===3?"íë¦¼":v<=48?"ì•ˆê°œ":v<=55?"ì´ìŠ¬ë¹„":v<=65?"ë¹„":v<=75?"ëˆˆ":v<=82?"ì†Œë‚˜ê¸°":"ë‡Œìš°";
    const wlv   = v => v<1.5?"ì”ì”":v<3.3?"ì•½í•œë°”ëŒ":v<5.4?"ì‚°ë“¤ë°”ëŒ":v<7.9?"ê±´ë“¤ë°”ëŒ":v<10.7?"í”ë“¤ë°”ëŒ":"ê°•í’";
    document.getElementById('w-icon').textContent   = emo(c.weather_code);
    document.getElementById('w-main').textContent   = `${wname(c.weather_code)} Â· ${wlv(c.wind_speed_10m)}`;
    document.getElementById('w-detail').textContent = `${dir}í’`;
    document.getElementById('w-wind').textContent   = `${c.wind_speed_10m.toFixed(1)}m/s`;
    document.getElementById('weather-bar').classList.add('visible');
  } catch(e) {}
}

// â”€â”€â”€ ìƒˆë¡œê³ ì¹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refresh() {
  if (!currentStation) return;
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  setTimeout(() => btn.classList.remove('spinning'), 800);
  const s = STATIONS[currentStation];
  await Promise.all([loadTide(currentStation), loadWeather(s.lat, s.lng)]);
}

// â”€â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const lastRegion  = localStorage.getItem('lastRegion')  || 'jeju';
  const lastStation = localStorage.getItem('lastStation');
  switchRegion(lastRegion);
  if (lastStation && STATIONS[lastStation]) selectStation(lastStation);
});

setInterval(() => { if (currentStation) refresh(); }, 600000);
</script>
</body>
</html>
