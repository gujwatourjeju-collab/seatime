<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë°”ë‹¹ë•Œ</title>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/gujwatourjeju-collab/seatime/main/logo.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/gujwatourjeju-collab/seatime/main/logo.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ë°”ë‹¹ë•Œ">
<meta name="theme-color" content="#0d1f2d">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="logo.png">
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;ë°”ë‹¹ë•Œ&quot;,&quot;short_name&quot;:&quot;ë°”ë‹¹ë•Œ&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://raw.githubusercontent.com/gujwatourjeju-collab/seatime/main/logo.png&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;}],&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#0d1f2d&quot;,&quot;theme_color&quot;:&quot;#0d1f2d&quot;}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --accent: #00c4a7;
    --danger: #ff6b6b;
    --muted: #6b8fa3;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    font-family:'Noto Sans KR',sans-serif;
    background:#0d1f2d; color:#fff;
    height:100dvh; overflow:hidden;
    display:flex; flex-direction:column;
  }

  /* ë°°ê²½ â€” ë” ì—°í•˜ê²Œ */
  .bg-ocean {
    position:fixed; inset:0; z-index:0;
    background:linear-gradient(180deg,#0d1f2d 0%,#0a3347 50%,#0a4f6e 100%);
    overflow:hidden;
  }
  .bg-wave {
    position:absolute; bottom:0; left:-50%; width:200%; height:180px;
    background:rgba(0,196,167,0.015); /* 0.04 â†’ 0.015 */
    border-radius:50%;
    animation:bgWave 8s ease-in-out infinite;
  }
  .bg-wave:nth-child(2){height:130px;bottom:20px;animation-duration:11s;animation-delay:-3s;}
  .bg-wave:nth-child(3){height:100px;bottom:40px;animation-duration:14s;animation-delay:-6s;}
  @keyframes bgWave{0%,100%{transform:translateX(0)}50%{transform:translateX(-5%)}}

  .app {
    position:relative; z-index:1;
    width:100%; max-width:480px; margin:0 auto;
    height:100dvh; display:flex; flex-direction:column; overflow:hidden;
  }

  /* í—¤ë” */
  .header {
    padding:48px 20px 10px;
    display:flex; align-items:center; justify-content:space-between;
    flex-shrink:0;
  }
  .header-left{display:flex;align-items:center;gap:10px;}
  .header-icon{
    width:36px;height:36px;border-radius:10px;
    background:linear-gradient(135deg,var(--accent),#0097a7);
    display:flex;align-items:center;justify-content:center;font-size:1.1rem;
  }
  .header-title{font-size:1.1rem;font-weight:900;letter-spacing:-0.5px;}
  .header-sub{font-size:0.65rem;color:var(--muted);font-weight:600;}
  .clock{font-family:'DM Mono',monospace;font-size:1.1rem;font-weight:500;color:var(--accent);letter-spacing:1px;}

  /* ìœ„ì¹˜ ì„ íƒ ë²„íŠ¼ */
  .location-btn-bar {
    padding:4px 20px 10px;
    flex-shrink:0;
  }
  .location-btn {
    display:flex; align-items:center; gap:8px;
    padding:9px 16px; border-radius:20px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(255,255,255,0.07);
    color:#fff; font-size:0.82rem; font-weight:700;
    cursor:pointer; font-family:'Noto Sans KR',sans-serif;
    transition:all 0.2s;
  }
  .location-btn:active{transform:scale(0.97);}
  .location-btn-icon{font-size:1rem;}
  .location-btn-text{flex:1;}
  .location-btn-arrow{font-size:0.7rem;opacity:0.5;}

  /* ì»¨í…ì¸  */
  .content{flex:1;overflow-y:auto;padding:0 16px 20px;scrollbar-width:none;}
  .content::-webkit-scrollbar{display:none;}

  /* ë‚ ì”¨ */
  .weather-bar{
    display:none;align-items:center;gap:10px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:14px;padding:10px 14px;margin-bottom:10px;
  }
  .weather-bar.visible{display:flex;}
  .w-icon{font-size:1.3rem;}
  .w-text{flex:1;font-size:0.78rem;font-weight:700;}
  .w-sub{font-size:0.65rem;color:var(--muted);}
  .w-wind{font-family:'DM Mono',monospace;font-size:0.9rem;font-weight:500;color:var(--accent);}

  /* íŒŒë„ ì¹´ë“œ */
  .wave-card{
    border-radius:24px;overflow:hidden;
    border:1px solid rgba(255,255,255,0.1);
    margin-bottom:10px;position:relative;height:160px;
    background:rgba(255,255,255,0.05);
  }
  .wave-fill{
    position:absolute;bottom:0;left:0;right:0;
    background:linear-gradient(180deg,rgba(0,196,167,0.25),rgba(0,196,167,0.6));
    height:0%;
    transition:height 2.2s cubic-bezier(0.4,0,0.2,1);
  }
  .wave-fill::before{
    content:"";position:absolute;top:-18px;left:-50%;width:200%;height:36px;
    background:rgba(0,196,167,0.35);border-radius:50%;
    animation:waveTop 4s ease-in-out infinite;
  }
  @keyframes waveTop{0%,100%{transform:translateX(0)}50%{transform:translateX(-8%)}}

  .wave-info{
    position:absolute;inset:0;z-index:2;
    display:flex;align-items:center;justify-content:space-between;
    padding:20px 24px;
  }
  .tide-name-badge{
    display:inline-block;background:var(--accent);color:#0d1f2d;
    font-size:0.65rem;font-weight:900;
    padding:2px 10px;border-radius:20px;margin-bottom:6px;letter-spacing:0.5px;
  }
  .level-display{font-family:'DM Mono',monospace;font-size:3.2rem;font-weight:500;line-height:1;letter-spacing:-2px;}
  .level-unit{font-size:1rem;opacity:0.6;margin-left:3px;}
  .tide-status{font-size:0.72rem;font-weight:700;color:var(--accent);margin-top:4px;display:flex;align-items:center;gap:3px;}
  .wave-right{text-align:right;}
  .time-left-label{font-size:0.6rem;color:var(--muted);font-weight:700;margin-bottom:2px;}
  .time-left-val{font-family:'DM Mono',monospace;font-size:1rem;font-weight:500;color:#fff;}

  .station-name-display{font-size:0.65rem;color:var(--muted);font-weight:700;margin-top:8px;letter-spacing:0.5px;}

  /* ìˆ˜ìœ„ ê²Œì´ì§€ */
  .tide-gauge{
    position:absolute; right:20px; top:14px; bottom:14px;
    width:28px; z-index:3;
    display:flex; flex-direction:column; align-items:center;
  }
  .gauge-label-top{
    font-size:0.52rem; font-weight:700; line-height:1.2; text-align:center;
    color:rgba(255,255,255,0.7);
  }
  .gauge-label-top span{ display:block; font-family:'DM Mono',monospace; font-size:0.6rem; color:var(--accent); }
  .gauge-bar{
    flex:1; width:4px; border-radius:2px;
    background:rgba(255,255,255,0.1);
    position:relative; margin:5px 0;
  }
  .gauge-bar-fill{
    position:absolute; bottom:0; left:0; right:0;
    background:linear-gradient(180deg, rgba(0,196,167,0.5), var(--accent));
    border-radius:2px;
    transition:height 2.2s cubic-bezier(0.4,0,0.2,1);
    height:0%;
  }
  .gauge-tick{
    position:absolute; left:-4px; right:-4px; height:1px;
    background:rgba(255,255,255,0.3);
  }
  .gauge-dot{
    position:absolute; left:50%; transform:translateX(-50%);
    width:8px; height:8px; border-radius:50%;
    background:var(--accent);
    border:2px solid #0d1f2d;
    transition:bottom 2.2s cubic-bezier(0.4,0,0.2,1);
    box-shadow:0 0 6px rgba(0,196,167,0.6);
  }
  .gauge-label-bot{
    font-size:0.52rem; font-weight:700; line-height:1.2; text-align:center;
    color:rgba(255,255,255,0.7);
  }
  .gauge-label-bot span{ display:block; font-family:'DM Mono',monospace; font-size:0.6rem; color:rgba(255,100,100,0.9); }

  /* ë¬¼ë•Œ ë¦¬ìŠ¤íŠ¸ */
  .tide-item{
    display:flex;align-items:center;justify-content:space-between;
    padding:11px 14px;border-radius:14px;margin-bottom:7px;
    background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);
  }
  .tide-item.current{background:rgba(0,196,167,0.1);border-color:rgba(0,196,167,0.3);}
  .tide-item.dim{opacity:0.4;}
  .tide-item-left{display:flex;align-items:center;gap:10px;}
  .tide-icon{font-size:0.9rem;width:18px;text-align:center;}
  .tide-level-text{font-size:0.95rem;font-weight:800;font-family:'DM Mono',monospace;letter-spacing:-0.5px;}
  .tide-label{font-size:0.6rem;color:var(--muted);margin-top:1px;font-weight:600;}
  .tide-time{font-family:'DM Mono',monospace;font-size:0.9rem;font-weight:500;color:rgba(255,255,255,0.65);}
  .day-badge{font-size:0.55rem;background:rgba(255,255,255,0.1);color:var(--muted);padding:1px 5px;border-radius:5px;font-weight:700;margin-left:5px;vertical-align:middle;}

  /* ë¡œë”© */
  .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:120px;gap:12px;color:var(--muted);}
  .loading-wave{display:flex;gap:5px;}
  .loading-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);opacity:0.3;animation:loadPulse 1.2s ease-in-out infinite;}
  .loading-dot:nth-child(2){animation-delay:0.2s;}
  .loading-dot:nth-child(3){animation-delay:0.4s;}
  @keyframes loadPulse{0%,100%{opacity:0.3;transform:scale(1)}50%{opacity:1;transform:scale(1.3)}}
  .loading-text{font-size:0.72rem;font-weight:700;letter-spacing:1px;}
  .error-msg{text-align:center;padding:30px;color:var(--danger);font-size:0.82rem;font-weight:700;}

  /* ìƒˆë¡œê³ ì¹¨ */
  .refresh-btn{
    position:fixed;bottom:20px;right:20px;
    width:48px;height:48px;border-radius:50%;
    background:var(--accent);border:none;color:#0d1f2d;cursor:pointer;
    box-shadow:0 4px 18px rgba(0,196,167,0.4);
    display:flex;align-items:center;justify-content:center;
    transition:all 0.2s;z-index:100;
  }
  .refresh-btn:active{transform:scale(0.92);}
  .refresh-btn.spinning svg{animation:spin 0.8s linear;}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

  .update-time{text-align:center;font-size:0.6rem;color:rgba(255,255,255,0.2);padding:6px;font-family:'DM Mono',monospace;}

  .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;gap:12px;color:var(--muted);padding:40px;}
  .empty-icon{font-size:2.5rem;opacity:0.4;}
  .empty-text{font-size:0.82rem;font-weight:700;text-align:center;line-height:1.6;}

  .footer-credit{
    text-align:center;padding:16px 20px 8px;
    border-top:1px solid rgba(255,255,255,0.06);
    margin-top:8px;
  }
  .credit-row{
    font-size:0.6rem;color:rgba(255,255,255,0.25);
    margin-bottom:4px;font-weight:600;
  }
  .credit-row a{color:rgba(255,255,255,0.3);text-decoration:none;}
  .credit-row a:hover{color:var(--accent);}
  .credit-divider{height:1px;background:rgba(255,255,255,0.06);margin:8px 0;}
  .credit-maker{color:rgba(255,255,255,0.35)!important;font-weight:700!important;}

  /* â”€â”€â”€ ë°”í…€ ì‹œíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sheet-overlay{
    position:fixed;inset:0;z-index:200;
    background:rgba(0,0,0,0.5);
    opacity:0;pointer-events:none;
    transition:opacity 0.3s;
  }
  .sheet-overlay.open{opacity:1;pointer-events:auto;}

  .sheet{
    position:fixed;bottom:0;left:0;right:0;z-index:201;
    max-width:480px;margin:0 auto;
    background:#0f2535;
    border-radius:24px 24px 0 0;
    border-top:1px solid rgba(255,255,255,0.1);
    transform:translateY(100%);
    transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);
    padding-bottom:env(safe-area-inset-bottom);
  }
  .sheet.open{transform:translateY(0);}

  .sheet-handle{
    width:36px;height:4px;border-radius:2px;
    background:rgba(255,255,255,0.2);
    margin:12px auto 0;
  }

  /* 1ë‹¨ê³„: ì§€ì—­ ì„ íƒ */
  .sheet-step{padding:16px 20px 24px;}
  .sheet-title{
    font-size:0.65rem;font-weight:700;letter-spacing:2px;
    color:var(--muted);text-transform:uppercase;margin-bottom:14px;
  }
  .region-grid{
    display:grid;grid-template-columns:1fr 1fr;gap:10px;
  }
  .region-item{
    display:flex;align-items:center;gap:10px;
    padding:14px 16px;border-radius:16px;
    border:1px solid rgba(255,255,255,0.1);
    background:rgba(255,255,255,0.05);
    cursor:pointer;transition:all 0.2s;
  }
  .region-item:active{transform:scale(0.97);}
  .region-item.active{background:rgba(0,196,167,0.15);border-color:var(--accent);}
  .region-emoji{font-size:1.4rem;}
  .region-label{font-size:0.9rem;font-weight:900;}
  .region-count{font-size:0.6rem;color:var(--muted);font-weight:600;margin-top:1px;}

  /* 2ë‹¨ê³„: ê´€ì¸¡ì†Œ ì„ íƒ */
  .sheet-back{
    display:flex;align-items:center;gap:6px;
    font-size:0.72rem;font-weight:700;color:var(--muted);
    cursor:pointer;margin-bottom:14px;
    background:none;border:none;padding:0;
    font-family:'Noto Sans KR',sans-serif;
  }
  .station-grid{
    display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;
  }
  .station-item{
    display:flex;flex-direction:column;align-items:center;gap:4px;
    padding:12px 8px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(255,255,255,0.04);
    cursor:pointer;transition:all 0.2s;text-align:center;
  }
  .station-item:active{transform:scale(0.95);}
  .station-item.active{background:rgba(0,196,167,0.15);border-color:var(--accent);}
  .station-item-emoji{font-size:1.1rem;}
  .station-item-name{font-size:0.72rem;font-weight:700;color:rgba(255,255,255,0.85);}
  .station-item.active .station-item-name{color:var(--accent);}
</style>
</head>
<body>

<div class="bg-ocean">
  <div class="bg-wave"></div><div class="bg-wave"></div><div class="bg-wave"></div>
</div>

<div class="app">

  <div class="header">
    <div class="header-left">
      <img src="https://raw.githubusercontent.com/gujwatourjeju-collab/seatime/main/logo.png" style="width:36px;height:36px;border-radius:10px;object-fit:cover;">
      <div>
        <div class="header-title">ë°”ë‹¹ë•Œ</div>
        <div class="header-sub">ë°”ë‹¤ ì•ì— ì„œê¸° ì „, ë°”ë‹¹ë•Œ ë¨¼ì €</div>
      </div>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </div>

  <!-- ìœ„ì¹˜ ì„ íƒ ë²„íŠ¼ -->
  <div class="location-btn-bar">
    <div class="location-btn" onclick="openSheet()">
      <span class="location-btn-icon" id="loc-icon">ğŸ“</span>
      <span class="location-btn-text" id="loc-text">ê´€ì¸¡ì†Œ ì„ íƒ</span>
      <span class="location-btn-arrow">â–¼</span>
    </div>
  </div>

  <div class="content">

    <div class="weather-bar" id="weather-bar">
      <div class="w-icon" id="w-icon">ğŸŒ¤</div>
      <div>
        <div class="w-text" id="w-main">--</div>
        <div class="w-sub" id="w-detail">ë°”ë‹¤ ë‚ ì”¨</div>
      </div>
      <div class="w-wind" id="w-wind">--</div>
    </div>

    <div class="wave-card" id="wave-card" style="display:none;">
      <div class="wave-fill" id="wave-fill"></div>
      <div class="wave-info" style="padding-right:56px;">
        <div>
          <div class="tide-name-badge" id="tide-name"></div>
          <div class="level-display"><span id="level-num">--</span><span class="level-unit">cm</span></div>
          <div class="tide-status" id="tide-status"></div>
        </div>
        <div class="wave-right">
          <div class="time-left-label">ë‹¤ìŒ ë¬¼ë•Œê¹Œì§€</div>
          <div class="time-left-val" id="time-left">--</div>
          <div class="station-name-display" id="station-display"></div>
        </div>
      </div>
      <!-- ìˆ˜ìœ„ ê²Œì´ì§€ -->
      <div class="tide-gauge">
        <div class="gauge-label-top" id="gauge-top-label">--<span id="gauge-top-val">--</span></div>
        <div class="gauge-bar">
          <div class="gauge-bar-fill" id="gauge-fill"></div>
          <div class="gauge-tick" style="top:50%;"></div>
          <div class="gauge-dot" id="gauge-dot"></div>
        </div>
        <div class="gauge-label-bot" id="gauge-bot-label">--<span id="gauge-bot-val">--</span></div>
      </div>
    </div>

    <div id="tide-list">
      <div class="empty-state">
        <div class="empty-icon">ğŸŒŠ</div>
        <div class="empty-text">ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
      </div>
    </div>

    <div class="update-time" id="update-time"></div>

    <div class="footer-credit">
      <div class="credit-row">ì¡°ì„ ë°ì´í„° Â· <a href="https://www.khoa.go.kr" target="_blank">êµ­ë¦½í•´ì–‘ì¡°ì‚¬ì› KHOA</a></div>
      <div class="credit-divider"></div>
      <div class="credit-row credit-maker">Made by Boungje Min</div>
    </div>
  </div>
</div>

<!-- ë°”í…€ ì‹œíŠ¸ -->
<div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>

  <!-- 1ë‹¨ê³„: ì§€ì—­ -->
  <div class="sheet-step" id="step-region">
    <div class="sheet-title">ì§€ì—­ ì„ íƒ</div>
    <div class="region-grid">
      <div class="region-item" onclick="selectRegion('jeju')">
        <span class="region-emoji">ğŸ</span>
        <div><div class="region-label">ì œì£¼</div><div class="region-count">6ê°œ ê´€ì¸¡ì†Œ</div></div>
      </div>
      <div class="region-item" onclick="selectRegion('west')">
        <span class="region-emoji">ğŸŒŠ</span>
        <div><div class="region-label">ì„œí•´</div><div class="region-count">17ê°œ ê´€ì¸¡ì†Œ</div></div>
      </div>
      <div class="region-item" onclick="selectRegion('south')">
        <span class="region-emoji">ğŸ¬</span>
        <div><div class="region-label">ë‚¨í•´</div><div class="region-count">5ê°œ ê´€ì¸¡ì†Œ</div></div>
      </div>
      <div class="region-item" onclick="selectRegion('east')">
        <span class="region-emoji">ğŸ”</span>
        <div><div class="region-label">ë™í•´</div><div class="region-count">3ê°œ ê´€ì¸¡ì†Œ</div></div>
      </div>
    </div>
  </div>

  <!-- 2ë‹¨ê³„: ê´€ì¸¡ì†Œ -->
  <div class="sheet-step" id="step-station" style="display:none;">
    <button class="sheet-back" onclick="backToRegion()">â† ì§€ì—­ ë‹¤ì‹œ ì„ íƒ</button>
    <div class="sheet-title" id="step-station-title">ê´€ì¸¡ì†Œ ì„ íƒ</div>
    <div class="station-grid" id="station-grid"></div>
  </div>
</div>

<button class="refresh-btn" id="refresh-btn" onclick="refresh()">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="23 4 23 10 17 10"></polyline>
    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
  </svg>
</button>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzsh-S8WvZwQemmNTAdoq6vL5GWmIXafge_fGwD7DmR92Ptg4EpuarIiZumEYMG3kl77Q/exec';

const STATIONS = {
  'ê¹€ë…•':    {type:'blend', obs1:'DT_0004',obs2:'DT_0022',w1:0.48,w2:0.52,timeCorr:+10,lat:33.558, lng:126.751,region:'jeju'},
  'ì œì£¼':    {type:'single',obs:'DT_0004', lat:33.5275,lng:126.543, region:'jeju'},
  'ì„±ì‚°í¬':  {type:'single',obs:'DT_0022', lat:33.4747,lng:126.927, region:'jeju'},
  'ì„œê·€í¬':  {type:'single',obs:'DT_0061', lat:33.2468,lng:126.561, region:'jeju'},
  'ëª¨ìŠ¬í¬':  {type:'single',obs:'DT_0020', lat:33.2147,lng:126.251, region:'jeju'},
  'ì¶”ìë„':  {type:'single',obs:'DT_0021', lat:33.9611,lng:126.889, region:'jeju'},
  'ë§ŒëŒ€í•­':  {type:'scale', obs:'DT_0050', scale:1.10,timeCorr:+3,lat:36.626, lng:126.309,region:'west'},
  'íƒœì•ˆ':    {type:'single',obs:'DT_0050', lat:36.7445,lng:126.297, region:'west'},
  'ì•ˆí¥':    {type:'single',obs:'DT_0067', lat:36.6747,lng:126.115, region:'west'},
  'ë³´ë ¹':    {type:'single',obs:'DT_0025', lat:36.4167,lng:126.483, region:'west'},
  'ì„œì²œë§ˆëŸ‰':{type:'single',obs:'DT_0051', lat:36.0833,lng:126.633, region:'west'},
  'êµ°ì‚°':    {type:'single',obs:'DT_0018', lat:35.9833,lng:126.717, region:'west'},
  'ìœ„ë„':    {type:'single',obs:'DT_0068', lat:35.6167,lng:126.300, region:'west'},
  'ì–´ì²­ë„':  {type:'single',obs:'DT_0037', lat:36.1167,lng:125.983, region:'west'},
  'í‘ì‚°ë„':  {type:'single',obs:'DT_0035', lat:34.6833,lng:125.433, region:'west'},
  'í–¥í™”ë„':  {type:'single',obs:'DT_0066', lat:35.8833,lng:126.517, region:'west'},
  'ì¸ì²œì†¡ë„':{type:'single',obs:'DT_0052', lat:37.3833,lng:126.633, region:'west'},
  'ê°•í™”ëŒ€êµ':{type:'single',obs:'DT_0032', lat:37.7333,lng:126.533, region:'west'},
  'ë•ì ë„':  {type:'single',obs:'DT_0065', lat:37.2333,lng:126.133, region:'west'},
  'êµ´ì—…ë„':  {type:'single',obs:'DT_0038', lat:37.1833,lng:126.250, region:'west'},
  'ëŒ€ì²­ë„':  {type:'single',obs:'DT_0036', lat:37.8333,lng:124.717, region:'west'},
  'ì—°í‰ë„':  {type:'single',obs:'DT_0060', lat:37.6667,lng:125.683, region:'west'},
  'ì¥í•­':    {type:'single',obs:'DT_0024', lat:36.0000,lng:126.700, region:'west'},
  'í†µì˜':    {type:'single',obs:'DT_0014', lat:34.8500,lng:128.433, region:'south'},
  'ê±°ë¬¸ë„':  {type:'single',obs:'DT_0031', lat:34.0167,lng:127.300, region:'south'},
  'ë§ˆì‚°':    {type:'single',obs:'DT_0062', lat:35.2000,lng:128.567, region:'south'},
  'ê°€ë•ë„':  {type:'single',obs:'DT_0063', lat:35.0167,lng:128.817, region:'south'},
  'ì§„í•´':    {type:'single',obs:'DT_0054', lat:35.1000,lng:128.700, region:'south'},
  'ì†ì´ˆ':    {type:'single',obs:'DT_0012', lat:38.2000,lng:128.600, region:'east'},
  'í›„í¬':    {type:'single',obs:'DT_0011', lat:36.6833,lng:129.450, region:'east'},
  'ìš¸ë¦‰ë„':  {type:'single',obs:'DT_0013', lat:37.5000,lng:130.900, region:'east'},
};

const REGION_INFO = {
  jeju:  {label:'ì œì£¼', emoji:'ğŸ'},
  west:  {label:'ì„œí•´', emoji:'ğŸŒŠ'},
  south: {label:'ë‚¨í•´', emoji:'ğŸ¬'},
  east:  {label:'ë™í•´', emoji:'ğŸ”'},
};

const EMOJI = {
  ê¹€ë…•:'ğŸ„',ì œì£¼:'ğŸŒŠ',ì„±ì‚°í¬:'ğŸŒ…',ì„œê·€í¬:'ğŸ¬',ëª¨ìŠ¬í¬:'âš“',ì¶”ìë„:'ğŸ”',
  ë§ŒëŒ€í•­:'ğŸ¦€',íƒœì•ˆ:'ğŸŒ¾',ì•ˆí¥:'â›µ',ë³´ë ¹:'ğŸ–',ì„œì²œë§ˆëŸ‰:'ğŸ£',êµ°ì‚°:'ğŸŒ‰',
  ìœ„ë„:'ğŸ',ì–´ì²­ë„:'âš“',í‘ì‚°ë„:'ğŸŒ‘',í–¥í™”ë„:'ğŸŒ¿',ì¸ì²œì†¡ë„:'ğŸ™',ê°•í™”ëŒ€êµ:'ğŸŒ',
  ë•ì ë„:'ğŸ”',êµ´ì—…ë„:'ğŸ¦…',ëŒ€ì²­ë„:'ğŸ”µ',ì—°í‰ë„:'ğŸŸ¡',ì¥í•­:'ğŸŒŠ',
  í†µì˜:'ğŸ¦ª',ê±°ë¬¸ë„:'ğŸ',ë§ˆì‚°:'ğŸŸ',ê°€ë•ë„:'âš“',ì§„í•´:'ğŸŒ¸',
  ì†ì´ˆ:'ğŸŒŠ',í›„í¬:'ğŸ£',ìš¸ë¦‰ë„:'ğŸŒ‹',
};

let currentStation = null;

// â”€â”€â”€ ì‹œê³„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const n = new Date();
  document.getElementById('clock').textContent =
    String(n.getHours()).padStart(2,'0')+':'+
    String(n.getMinutes()).padStart(2,'0')+':'+
    String(n.getSeconds()).padStart(2,'0');
}
setInterval(updateClock,1000); updateClock();

// â”€â”€â”€ ë°”í…€ ì‹œíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSheet() {
  document.getElementById('sheet-overlay').classList.add('open');
  document.getElementById('sheet').classList.add('open');
  showRegionStep();
}
function closeSheet() {
  document.getElementById('sheet-overlay').classList.remove('open');
  document.getElementById('sheet').classList.remove('open');
}
function showRegionStep() {
  document.getElementById('step-region').style.display = 'block';
  document.getElementById('step-station').style.display = 'none';
  // í˜„ì¬ ì§€ì—­ í™œì„±í™”
  document.querySelectorAll('.region-item').forEach(el => {
    const r = el.getAttribute('onclick').match(/'(\w+)'/)?.[1];
    el.classList.toggle('active', currentStation && STATIONS[currentStation]?.region === r);
  });
}
function backToRegion() {
  showRegionStep();
}
function selectRegion(region) {
  // 2ë‹¨ê³„ë¡œ ì „í™˜
  document.getElementById('step-region').style.display = 'none';
  document.getElementById('step-station').style.display = 'block';

  const info = REGION_INFO[region];
  document.getElementById('step-station-title').textContent = `${info.emoji} ${info.label} ê´€ì¸¡ì†Œ`;

  const names = Object.keys(STATIONS).filter(k => STATIONS[k].region === region);
  document.getElementById('station-grid').innerHTML = names.map(name => `
    <div class="station-item ${currentStation===name?'active':''}" onclick="pickStation('${name}')">
      <span class="station-item-emoji">${EMOJI[name]||'ğŸ“'}</span>
      <span class="station-item-name">${name}</span>
    </div>`).join('');
}
function pickStation(name) {
  closeSheet();
  selectStation(name);
}

// â”€â”€â”€ ê´€ì¸¡ì†Œ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function selectStation(name) {
  currentStation = name;
  localStorage.setItem('lastStation', name);

  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  const region = STATIONS[name].region;
  const rInfo  = REGION_INFO[region];
  document.getElementById('loc-icon').textContent = EMOJI[name] || 'ğŸ“';
  document.getElementById('loc-text').textContent = `${rInfo.label} Â· ${name}`;

  const s = STATIONS[name];
  await Promise.all([loadTide(name), loadWeather(s.lat, s.lng)]);
}

// â”€â”€â”€ ë¬¼ë•Œ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTide(name) {
  showLoading();
  document.getElementById('wave-card').style.display = 'none';
  try {
    const s = STATIONS[name];
    let data;
    if (s.type === 'blend') {
      const [r1,r2] = await Promise.all([callGAS(s.obs1),callGAS(s.obs2)]);
      data = blendTides(r1,r2,s.w1,s.w2,s.timeCorr);
    } else if (s.type === 'scale') {
      data = scaleTides(await callGAS(s.obs), s.scale, s.timeCorr);
    } else {
      data = await callGAS(s.obs);
    }
    data = data.filter(d => d && (d.isCurrent || d.time));
    if (!data.length || data[0]?.error) { showError(data[0]?.error||'ë°ì´í„° ì—†ìŒ'); return; }
    renderTide(data, name);
    document.getElementById('update-time').textContent = `ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
  } catch(e) { showError('ì˜¤ë¥˜: '+e.message); }
}

async function callGAS(obsCode) {
  try {
    const url = GAS_URL + "?obsCode=" + encodeURIComponent(obsCode);
    const res = await fetch(url);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const data = JSON.parse(text);
    if (!Array.isArray(data)) {
      console.error("GAS ë¹„ë°°ì—´ ì‘ë‹µ:", text.substring(0,200));
      throw new Error("ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜");
    }
    return data;
  } catch(e) {
    console.error("GAS ì˜¤ë¥˜:", obsCode, e);
    return [{error: e.message}];
  }
}

// â”€â”€â”€ ê°€ì¤‘í‰ê·  (ê¹€ë…•) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function blendTides(data1,data2,w1,w2,timeCorr) {
  const tides1=data1.filter(d=>!d.isCurrent);
  const tides2=data2.filter(d=>!d.isCurrent);
  const current=data1.find(d=>d.isCurrent);
  const used=new Set(), blended=[];
  tides1.forEach(t1=>{
    const matched=tides2
      .filter(t2=>t2.type===t1.type&&!used.has(t2.time))
      .sort((a,b)=>Math.abs(toMins(a)-toMins(t1))-Math.abs(toMins(b)-toMins(t1)))[0];
    if(!matched)return;
    used.add(matched.time);
    const bMins=Math.round(toMins(t1)*w1+toMins(matched)*w2)+timeCorr;
    const bLevel=Math.round(t1.level*w1+matched.level*w2);
    blended.push({...t1,time:minsToTime(bMins),mins:bMins,level:bLevel});
  });
  blended.sort((a,b)=>a.mins-b.mins);
  if(current){
    const nowMins=toMins(current);
    let nowLevel=current.level;
    for(let i=0;i<blended.length;i++){
      if(nowMins<blended[i].mins){
        if(i>0){const p=blended[i-1],n=blended[i];nowLevel=Math.round(p.level+(n.level-p.level)*(nowMins-p.mins)/(n.mins-p.mins));}
        break;
      }
    }
    const idx=blended.findIndex(t=>t.mins>nowMins);
    const cur={...current,level:nowLevel};
    if(idx===-1)blended.push(cur);else blended.splice(idx,0,cur);
  }
  return blended;
}

// â”€â”€â”€ ìˆ˜ìœ„ ë³´ì • (ë§ŒëŒ€í•­) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scaleTides(data,scale,timeCorr){
  return data.map(item=>{
    if(item.isCurrent)return item;
    const newMins=toMins(item)+timeCorr;
    return{...item,time:minsToTime(newMins),mins:newMins,level:Math.round(item.level*scale)};
  });
}

// â”€â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toMins(item){
  if(!item)return 0;
  if(item.mins!=null)return item.mins;
  if(!item.time)return 0;
  const[h,m]=item.time.split(':').map(Number);
  return item.isNextDay?h*60+m+1440:h*60+m;
}
function minsToTime(mins){
  const abs=((mins%1440)+1440)%1440;
  return String(Math.floor(abs/60)).padStart(2,'0')+':'+String(abs%60).padStart(2,'0');
}

// â”€â”€â”€ íŒŒë„ ì• ë‹ˆë©”ì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateWave(pct, isFalling){
  const el=document.getElementById('wave-fill');
  el.style.transition='none';
  el.style.height=isFalling?'100%':'0%';
  void el.offsetWidth;
  el.style.transition='height 2.2s cubic-bezier(0.4,0,0.2,1)';
  setTimeout(()=>{el.style.height=pct+'%';},80);
}

function updateGauge(data, current, pct) {
  const nowMins  = toMins(current);
  const tides    = data.filter(d => !d.isCurrent);
  const isFalling = data.find(d=>!d.isCurrent&&toMins(d)>nowMins)?.type==='low';

  let fromTide, toTide;
  if (!isFalling) {
    // ì°¨ì˜¤ë¥´ëŠ” ì¤‘: ì§ì „ ê°„ì¡° â†’ ë‹¤ìŒ ë§Œì¡°
    fromTide = [...tides].reverse().find(d => toMins(d) < nowMins && d.type==='low');
    toTide   = tides.find(d => toMins(d) > nowMins && d.type==='high');
  } else {
    // ë¹ ì§€ëŠ” ì¤‘: ì§ì „ ë§Œì¡° â†’ ë‹¤ìŒ ê°„ì¡°
    fromTide = [...tides].reverse().find(d => toMins(d) < nowMins && d.type==='high');
    toTide   = tides.find(d => toMins(d) > nowMins && d.type==='low');
  }

  // ìƒë‹¨ = ë†’ì€ ìª½(ë§Œì¡°), í•˜ë‹¨ = ë‚®ì€ ìª½(ê°„ì¡°)
  const highTide = isFalling ? fromTide : toTide;
  const lowTide  = isFalling ? toTide   : fromTide;

  document.getElementById('gauge-top-label').childNodes[0].textContent = highTide ? 'ë§Œì¡°' : '--';
  document.getElementById('gauge-top-val').textContent  = highTide ? highTide.level+'cm' : '--';
  document.getElementById('gauge-bot-label').childNodes[0].textContent = lowTide ? 'ê°„ì¡°' : '--';
  document.getElementById('gauge-bot-val').textContent  = lowTide ? lowTide.level+'cm' : '--';

  // ê²Œì´ì§€ fill & dot ìœ„ì¹˜: ê°„ì¡°~ë§Œì¡° ë²”ìœ„ ë‚´ í˜„ì¬ ìœ„ì¹˜
  const lowL  = lowTide  ? lowTide.level  : Math.min(...data.map(d=>d.level));
  const highL = highTide ? highTide.level : Math.max(...data.map(d=>d.level));
  const gaugePct = highL > lowL ? ((current.level - lowL) / (highL - lowL)) * 100 : 50;
  setTimeout(() => {
    document.getElementById('gauge-fill').style.height = gaugePct + '%';
    document.getElementById('gauge-dot').style.bottom  = 'calc('+gaugePct+'% - 4px)';
  }, 80);
}

// â”€â”€â”€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTide(data,name){
  const current=data.find(d=>d.isCurrent);
  if(!current){showError('í˜„ì¬ ë°ì´í„° ì—†ìŒ');return;}

  document.getElementById('wave-card').style.display='block';
  document.getElementById('station-display').textContent=`ğŸ“ ${name}`;

  const tideNameEl=document.getElementById('tide-name');
  tideNameEl.textContent=current.tideName||'';
  tideNameEl.style.display=current.tideName?'inline-block':'none';
  document.getElementById('level-num').textContent=current.level;

  const nowMins=toMins(current);
  const nextTide=data.find(d=>!d.isCurrent&&toMins(d)>nowMins);
  const isFalling=nextTide?.type==='low';

  if(nextTide){
    const diff=toMins(nextTide)-nowMins;
    const h=Math.floor(diff/60),m=diff%60;
    document.getElementById('tide-status').innerHTML=`<span>${isFalling?'â†“':'â†‘'}</span> ë¬¼ì´ ${isFalling?'ë¹ ì§€ëŠ” ì¤‘':'ì°¨ì˜¤ë¥´ëŠ” ì¤‘'}`;
    document.getElementById('time-left').textContent=`${isFalling?'ê°„ì¡°':'ë§Œì¡°'} ${h>0?h+'ì‹œê°„ ':''}${m}ë¶„ ì „`;
  }

  const levels=data.map(d=>d.level).filter(Boolean);
  const minL=Math.min(...levels),maxL=Math.max(...levels);
  const pct=maxL>minL?((current.level-minL)/(maxL-minL))*75+15:50;
  animateWave(pct, isFalling);
  updateGauge(data, current, pct);

  document.getElementById('tide-list').innerHTML=data.map(item=>{
    const isCur=item.isCurrent;
    const isDim=item.isYesterday||item.isNextDay;
    const icon=isCur?'ğŸ“':item.type==='high'?'â–²':'â–¼';
    const color=isCur?'#00c4a7':item.type==='high'?'#5ba4f5':'#ff6b6b';
    const label=isCur?'í˜„ì¬ ì˜ˆìƒ ìˆ˜ìœ„':item.type==='high'?'ë§Œì¡°':'ê°„ì¡°';
    const badge=item.isYesterday?'<span class="day-badge">ì–´ì œ</span>':item.isNextDay?'<span class="day-badge">ë‚´ì¼</span>':'';
    return`<div class="tide-item ${isCur?'current':''} ${isDim?'dim':''}">
        <div class="tide-item-left">
          <div class="tide-icon" style="color:${color}">${icon}</div>
          <div><div class="tide-level-text">${item.level}cm${badge}</div><div class="tide-label">${label}</div></div>
        </div>
        <div class="tide-time">${item.time}</div>
      </div>`;
  }).join('');
}

function showLoading(){
  document.getElementById('tide-list').innerHTML=`<div class="loading"><div class="loading-wave"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div><div class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘</div></div>`;
  document.getElementById('level-num').textContent='--';
  document.getElementById('tide-status').textContent='';
  document.getElementById('time-left').textContent='--';
  document.getElementById('wave-fill').style.height='0%';
}
function showError(msg){
  document.getElementById('tide-list').innerHTML=`<div class="error-msg">âš ï¸ ${msg}</div>`;
  document.getElementById('wave-card').style.display='none';
}

// â”€â”€â”€ ë‚ ì”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadWeather(lat,lng){
  try{
    const c=(await(await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m,weather_code&wind_speed_unit=ms&timezone=Asia/Seoul`)).json()).current;
    const dirs=["ë¶","ë¶ë™","ë™","ë‚¨ë™","ë‚¨","ë‚¨ì„œ","ì„œ","ë¶ì„œ"];
    const dir=dirs[Math.round(c.wind_direction_10m/45)%8];
    const emo=v=>v===0?"â˜€ï¸":v<=2?"ğŸŒ¤":v===3?"â˜ï¸":v<=48?"ğŸŒ«":v<=55?"ğŸŒ¦":v<=65?"ğŸŒ§":v<=75?"â„ï¸":v<=82?"ğŸŒ§":"â›ˆ";
    const wname=v=>v===0?"ë§‘ìŒ":v<=2?"ëŒ€ì²´ë¡œ ë§‘ìŒ":v===3?"íë¦¼":v<=48?"ì•ˆê°œ":v<=55?"ì´ìŠ¬ë¹„":v<=65?"ë¹„":v<=75?"ëˆˆ":v<=82?"ì†Œë‚˜ê¸°":"ë‡Œìš°";
    const wlv=v=>v<1.5?"ì”ì”":v<3.3?"ì•½í•œë°”ëŒ":v<5.4?"ì‚°ë“¤ë°”ëŒ":v<7.9?"ê±´ë“¤ë°”ëŒ":v<10.7?"í”ë“¤ë°”ëŒ":"ê°•í’";
    document.getElementById('w-icon').textContent=emo(c.weather_code);
    document.getElementById('w-main').textContent=`${wname(c.weather_code)} Â· ${wlv(c.wind_speed_10m)}`;
    document.getElementById('w-detail').textContent=`${dir}í’`;
    document.getElementById('w-wind').textContent=`${c.wind_speed_10m.toFixed(1)}m/s`;
    document.getElementById('weather-bar').classList.add('visible');
  }catch(e){}
}

// â”€â”€â”€ ìƒˆë¡œê³ ì¹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refresh(){
  if(!currentStation)return;
  const btn=document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  setTimeout(()=>btn.classList.remove('spinning'),800);
  const s=STATIONS[currentStation];
  await Promise.all([loadTide(currentStation),loadWeather(s.lat,s.lng)]);
}

// â”€â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded',()=>{
  const last=localStorage.getItem('lastStation');
  if(last&&STATIONS[last])selectStation(last);
});

setInterval(()=>{if(currentStation)refresh();},600000);

// â”€â”€â”€ PWA ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/seatime/sw.js").catch(()=>{});
}
</script>
</body>
</html>
